name: Download VS Code Server (stable x64)

on:
  workflow_dispatch: {}

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          set -euo pipefail
          COMMIT="6f17636121051a53c88d3e605c491d22af2ba755"
          PLATFORM="server-linux-x64"
          CHANNEL="stable"
          URL_MS="https://update.code.visualstudio.com/commit:${COMMIT}/${PLATFORM}/${CHANNEL}"
          URL_CDN="https://az764295.vo.msecnd.net/stable/${COMMIT}/vscode-server-linux-x64.tar.gz"
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "URL_MS=$URL_MS"   >> $GITHUB_ENV
          echo "URL_CDN=$URL_CDN" >> $GITHUB_ENV

      - name: Download (verbose)
        run: |
          set -euo pipefail
          echo "Primary: $URL_MS"
          curl -L --retry 3 --retry-delay 2 -v "$URL_MS" -o pkg || echo PRIMARY_FAIL > .status
          if [ -f .status ]; then
            echo "Fallback: $URL_CDN"
            curl -L --retry 3 --retry-delay 2 -v "$URL_CDN" -o pkg
          fi

      - name: Show file info
        run: |
          ls -lh pkg
          file pkg || true

      - name: Verify contains server.sh
        run: |
          if file pkg | grep -qi gzip; then
            LIST="tar -tzf pkg"
          else
            LIST="tar -tf pkg"
          fi
          $LIST | sed -n '1,40p' || true
          $LIST | grep -q '/server\.sh$' || { echo "ERROR: no server.sh"; exit 1; }
          mv pkg vscode-server-linux-x64.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-server-linux-x64
          path: vscode-server-linux-x64.tar.gz
          retention-days: 7
